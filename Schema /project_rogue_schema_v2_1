-- Project Rogue MVP schema (Postgres / Supabase)
-- Notes:
-- - Use UUID primary keys
-- - Add RLS policies in Supabase after creating tables
-- - Keep forecasts immutable via app logic + optional DB triggers

create extension if not exists "uuid-ossp";

-- ENUMS
do $$ begin
  create type investment_type as enum ('SAFE','CLN','EQUITY','OTHER');
exception when duplicate_object then null; end $$;

do $$ begin
  create type investment_status as enum ('ACTIVE','EXITED','WRITTEN_OFF');
exception when duplicate_object then null; end $$;

do $$ begin
  create type founder_update_status as enum ('SUBMITTED','LATE','OVERDUE');
exception when duplicate_object then null; end $$;

do $$ begin
  create type flag_status as enum ('NEW','ACKNOWLEDGED','MONITORING','RESOLVED');
exception when duplicate_object then null; end $$;

do $$ begin
  create type flag_type as enum (
    'REVENUE_MISS','TRACTION_MISS','BURN_SPIKE','BURN_CRITICAL','RUNWAY_RISK','RUNWAY_CRITICAL','LATE_UPDATE'
  );
exception when duplicate_object then null; end $$;

do $$ begin
  create type metric_type as enum ('REVENUE','BURN','TRACTION','HEADCOUNT');
exception when duplicate_object then null; end $$;

-- INVESTMENTS
create table if not exists investments (
  id uuid primary key default uuid_generate_v4(),
  company_name text not null,
  sector text not null,
  stage text not null,
  investment_amount numeric(18,2) not null,
  currency text not null default 'USD',
  investment_type investment_type not null,
  investment_date date not null,
  status investment_status not null default 'ACTIVE',
  created_at timestamptz not null default now(),
  created_by uuid null,
  updated_at timestamptz not null default now()
);

-- FOUNDERS (simple per-investment)
create table if not exists founders (
  id uuid primary key default uuid_generate_v4(),
  investment_id uuid not null references investments(id) on delete cascade,
  name text not null,
  email text not null,
  created_at timestamptz not null default now()
);

-- ACCESS CONTROL (map platform users to investments/roles)
-- role: 'DEAL_OWNER' | 'IC_MEMBER'
create table if not exists investment_access (
  id uuid primary key default uuid_generate_v4(),
  investment_id uuid not null references investments(id) on delete cascade,
  user_id uuid not null,
  role text not null,
  created_at timestamptz not null default now(),
  unique(investment_id, user_id, role)
);

-- FORECAST (versioned)
create table if not exists forecasts (
  id uuid primary key default uuid_generate_v4(),
  investment_id uuid not null references investments(id) on delete cascade,
  version int not null,
  start_quarter date not null, -- e.g. first day of the quarter of investment_date
  horizon_quarters int not null default 8,
  rationale text null, -- required for version > 1
  created_at timestamptz not null default now(),
  created_by uuid null,
  unique(investment_id, version)
);

-- FORECAST METRICS (quarterly points)
create table if not exists forecast_metrics (
  id uuid primary key default uuid_generate_v4(),
  forecast_id uuid not null references forecasts(id) on delete cascade,
  metric metric_type not null,
  quarter_index int not null, -- 1..horizon_quarters
  value numeric(18,2) not null,
  created_at timestamptz not null default now(),
  unique(forecast_id, metric, quarter_index)
);

-- FOUNDER UPDATES (actuals)
create table if not exists founder_updates (
  id uuid primary key default uuid_generate_v4(),
  investment_id uuid not null references investments(id) on delete cascade,
  quarter_index int not null, -- aligns to forecast quarter_index
  due_date date not null,
  submitted_at timestamptz not null default now(),
  status founder_update_status not null default 'SUBMITTED',
  actual_revenue numeric(18,2) not null,
  actual_burn numeric(18,2) not null,
  actual_runway_months numeric(10,2) not null,
  actual_traction numeric(18,2) not null,
  narrative_good text null,
  narrative_bad text null,
  narrative_help text null,
  created_at timestamptz not null default now(),
  unique(investment_id, quarter_index)
);

-- FLAGS (append-only; status changes tracked with fields)
create table if not exists flags (
  id uuid primary key default uuid_generate_v4(),
  investment_id uuid not null references investments(id) on delete cascade,
  founder_update_id uuid null references founder_updates(id) on delete set null,
  type flag_type not null,
  metric metric_type null,
  threshold text not null,
  actual_value numeric(18,2) null,
  forecast_value numeric(18,2) null,
  delta_pct numeric(10,4) null,
  status flag_status not null default 'NEW',
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  resolved_at timestamptz null,
  resolution_note text null
);

-- INVESTOR NOTES
create table if not exists notes (
  id uuid primary key default uuid_generate_v4(),
  investment_id uuid not null references investments(id) on delete cascade,
  author_user_id uuid not null,
  body text not null,
  created_at timestamptz not null default now()
);

-- TOKEN LINKS FOR FOUNDERS (magic links per check-in)
create table if not exists founder_tokens (
  id uuid primary key default uuid_generate_v4(),
  investment_id uuid not null references investments(id) on delete cascade,
  quarter_index int not null,
  token text not null,
  expires_at timestamptz not null,
  used_at timestamptz null,
  created_at timestamptz not null default now(),
  unique(investment_id, quarter_index, token)
);
